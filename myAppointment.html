<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="cleartype" content="on">
<meta name="viewport" content="width=device-width, user-scalable=no, minimal-ui">
<link rel="dns-prefetch" href="//jiefangqu.com">

<title>我的预约</title>
<link rel="stylesheet" href="css/shopping.common.css">
</head>

<body class="bggrey">
	<section id="wrapBox" class="sectionBox bggrey pos-relative minheight100">
		<section id="tabBox" class="tabBox pos-relative">
		    <div class="hd tab-head bgwhite">
		        <ul class="order-tab">
		            <li id="orderTab01" class="wp50 tap-nobg order-tab-title" data-page="1" status="3"><a href="javascript:void(0)">已预约</a></li>
		            <li id="orderTab02" class="wp50 tap-nobg order-tab-title" data-page="1" status="4"><a href="javascript:void(0)">已结束</a></li>
		        </ul>
		    </div>
		    <section class="divide-box bordertbgrey" style="margin-top: -1px;"></section>
		    <div class="bd my-order" id="tabBox-bd">
		        <div class="con dsn">
		            <div id="tabOne">
		                <div class="myOrderList bgwhite">
		                   <div class="my-order-item hide">
		                       <a href="myAppointmentDetails.html">
			                       <div class="displaybox order-title-info">
			                            <div class="order-title-time boxflex01 mleft15"><span class="f16">下水道疏通</span><br><span class="grey">3天前 15:30</span></div>
			                            <div class="order-title-buff mright15 "><img src="images/icons-shop-clock-grey.png" /> <span class="order-title-buff-text grey">系统正在派单</span></div>
			                       </div>
			                       <div class="displaybox order-info-box bordertopgrey">
			                            <ul class="order-info-address boxflex01">
			                                <li class="icon-address"><span class="icon-address-text">星海名城1期A栋5008室</span></li>
			                                <li class="icon-datetime mtop10">2015-12-22 10:30</li>
			                            </ul>
			                       </div>
		                       </a>
		                       <div class="item-list-arrow-box p00"><input class="btn-submit btn-next noradius bordertbgrey btnSubmit bgwhite black" type="button" name="button" value="取消订单"></div>
		    					<section class="divide-box bordertbgrey"></section>
		                   </div>
		                   <div class="my-order-item">
		                       <a href="myAppointmentDetails.html">
			                       <div class="displaybox order-title-info">
			                            <div class="order-title-time boxflex01 mleft15"><span class="f16">下水道疏通1</span><br><span class="grey">3天前 15:30</span></div>
			                            <div class="order-title-buff mright15 orange"><img class="w10" src="images/icon_master.png" /> <span class="order-title-buff-text">师傅已接单</span></div>
			                       </div>
			                       <div class="displaybox order-info-box bordertopgrey">
			                            <ul class="order-info-address boxflex01">
			                                <li class="icon-address"><span class="icon-address-text">星海名城1期A栋5008室</span></li>
			                                <li class="icon-datetime mtop10">2015-12-22 10:30</li>
			                            </ul>
			                       </div>
		                       </a>
		                       <div class="displaybox order-info-box bordertopgrey">
		                            <div class="master-info-img"><img src="images/master_info_img.png" /></div>
		                            <ul class="order-info-address boxflex01">
				                        <li>
				                        	<div class="icon-person master-info-name f16 lineheightnormal mtop3">李师傅</div>
							            	<div class="star-box">
							            		<div class="star-shape"><img src="images/stars_small.png" /></div>
							            		<div class="star-bgred" data-width="90%"></div>
							            		<div class="star-bggrey"></div>
							            	</div>
				                        </li>
		                            </ul>
		                            <div class="order-info-phone-call noborder"><a href="tel:400-960-2228"><img src="images/icon-phone-call.png" /></a></div>
		                       </div>
		                       <div class="item-list-arrow-box p00"><input class="btn-submit btn-next noradius bordertbgrey btnSubmit bgwhite red" type="button" name="button" value="支付订单"></div>
		    					<section class="divide-box bordertbgrey"></section>
		                   </div>
		                   <div class="my-order-item">
		                       <a href="myAppointmentDetails.html">
			                       <div class="displaybox order-title-info">
			                            <div class="order-title-time boxflex01 mleft15"><span class="f16">下水道疏通2</span><br><span class="grey">3天前 15:30</span></div>
			                            <div class="order-title-buff mright15 orange"><img class="w10" src="images/icon_master.png" /> <span class="order-title-buff-text">师傅已接单</span></div>
			                       </div>
			                       <div class="displaybox order-info-box bordertopgrey">
			                            <ul class="order-info-address boxflex01">
			                                <li class="icon-address"><span class="icon-address-text">星海名城1期A栋5008室</span></li>
			                                <li class="icon-datetime mtop10">2015-12-22 10:30</li>
			                            </ul>
			                       </div>
		                       </a>
		                       <div class="displaybox order-info-box bordertopgrey">
		                            <div class="master-info-img"><img src="images/master_info_img.png" /></div>
		                            <ul class="order-info-address boxflex01">
				                        <li>
				                        	<div class="icon-person master-info-name f16 lineheightnormal mtop3">李师傅</div>
							            	<div class="star-box">
							            		<div class="star-shape"><img src="images/stars_small.png" /></div>
							            		<div class="star-bgred" data-width="60%"></div>
							            		<div class="star-bggrey"></div>
							            	</div>
				                        </li>
		                            </ul>
		                            <div class="order-info-phone-call noborder"><a href="tel:400-960-2228"><img src="images/icon-phone-call.png" /></a></div>
		                       </div>
		                       <div class="item-list-arrow-box p00"><input class="btn-submit btn-next noradius bordertbgrey btnSubmit bgwhite red" type="button" name="button" value="支付订单"></div>
		    					<section class="divide-box bordertbgrey"></section>
		                   </div>
		                </div>
		            </div>
		        </div>
		        <div class="con dsn">
		            <div id="tabTwo">
		                <div class="myOrderList bgwhite">
		                   
		                </div>
		            </div>
		        </div>
		    </div>
		</section>
		
		<section class="sectionBox wrap-bg pop-box02 hide">
			<div class="tips-box pay-tips bgred pb15">
				<img class="disblock" src="images/pay-tips.png"/>	
			</div>
		</section>

	</section>
<div class="sectionBox loading grey borderbottomgrey hide"><img src="images/loading01.gif" /> 加载中…</div>
<script src="js/jquery-1.11.2.min.js"></script>
<script src="js/fastclick.js"></script>
<script>
	$(function(){
		new FastClick(document.body);
		
		//弹出层
		$('.pay-tips').click(function(){
			$('#wrapBox').removeClass('heightp100');
			$('.pop-box02').addClass('dsn');
		});
		
		(function isImgLoaded(){
			//判断图片是否加载完成
			var t_img; // 定时器
			var isLoad = true; // 控制变量
			// 判断图片加载状况，加载完成后回调
			isImgLoad(function(){
				//弹出层图片居中
				var tipsBoxHeight = $('.pop-box02').height();
				var tipsBoxImgHeight = $('.pay-tips img').height();
				$('.pay-tips').css('margin-top', (tipsBoxHeight-tipsBoxImgHeight)/2);
			});
			
			// 判断图片加载的函数
			function isImgLoad(callbackFun){
				// 查找所有封面图，迭代处理
				$('.pop-box02').each(function(i){
					// 找到为0就将isLoad设为false，并退出each
					var itemListPicHeight = $(this).find('img').height();
					var itemListPicSrc = $(this).find('img').attr('src');
					//console.log('itemListPicHeight:', itemListPicHeight, itemListPicSrc, 'i:', i);
					if(itemListPicHeight === 0){
						//console.log('高度为0');
						isLoad = false;
						return false;
					}
				});
				// 为true，没有发现为0的。加载完毕
				if(isLoad){
					clearTimeout(t_img); // 清除定时器
					// 回调函数
					callbackFun();
				// 为false，因为找到了没有加载完成的图，将调用定时器递归
				}else{
					isLoad = true;
					t_img = setTimeout(function(){
						isImgLoad(callbackFun); // 递归扫描
					},500); // 我这里设置的是500毫秒就扫描一次，可以自己调整
				}
			}
		})();
		
		//设置星级
		$('.star-box').each(function(){
			var $thisStar = $(this).find('.star-bgred');
			var thisWidth = $thisStar.data('width');
			
			setMasterStars($thisStar, thisWidth);
			
		});
	})
	
	//星级评价
	function setMasterStars(obj, widthPercent){
		$(obj).animate({'width':widthPercent}, 1200);
	}
</script>

<script>	
	var num = 1;//每页显示的个数
	var n = 0;
	var m = -num;
	var $loading = $('.loading');
	//分页加载订单
	function ajax(pageType,tabTitle){
		$.ajax({
			type:"get",
			url:"js/cinema.js",
			//data:{page: pageNum: status:}
			dataType:"json",
			beforeSend:function(data){
				if($('.newLoading').length == 0){
					$loading.clone(true).addClass('newLoading').removeClass('hide').appendTo('.myOrderList');
				}
			},
			success:function(data){
				if( pageType=="next"){ //下一页
					n += num;
					m += num;
				}
				var $orderTabTitleOn = $(tabTitle);
				
				//listIndexOn等于0为待处理状态，listIndexOn等于1为已处理状态
				var listIndexOn = $orderTabTitleOn.index();
				
				//当前tab
				var listIndexCur = $('.order-tab-title.on').index();
				var $myOrderListBoxCur = $('.con').eq(listIndexCur).find('.myOrderList');
				
				//滚动时，当前tab加载下一页，status为当前状态的数据，加载到这里
					
				var page = $orderTabTitleOn.attr('data-page')*1;
				var $myOrderListBox = $('.con').eq(listIndexOn).find('.myOrderList');
				var $myOrderItem = $('.my-order-item.hide');
				$.each(data,function(i,val){
					
					$.each(val.dataValue.list,function(iPro,dataPro){
						
						if(iPro>=m && iPro<n){
							
							var $myOrderItemClone = $myOrderItem.clone(true);
							var cinemaCity = dataPro.deliverAddr;
							//将订单数据更新至$myOrderItemClone
							$myOrderItemClone.find('.icon-address-text').text(cinemaCity);
														
							//未处理订单，插入订单号
							if($orderTabTitleOn.attr('status') == 3){
								$myOrderItemClone.find('.item-list-check-btn-box').attr('data-id', dataPro.id)	
							}
							//已处理订单，去除按钮
							if($orderTabTitleOn.attr('status') == 4){
								$myOrderItemClone.find('.item-list-check-btn-box').remove();	
							}
							//插入页面
							$myOrderItemClone.removeClass('hide').appendTo($myOrderListBox);						
						}
					});
						
				});
				//当前页数
				page += 1;
				$orderTabTitleOn.attr('data-page', page);
				//重设外层高度
				$("#tabBox .tempWrap").height($myOrderListBoxCur.height());
				
				
				
				setTimeout(function(){
					$('.newLoading').remove();
				},400);
			}
		});
	};
	
	
	//订单按钮  确认发货
	$('.item-list-arrow-box').click(function(){
		console.log($(this).attr('data-id'));
		
		if(!confirm('确定取消该订单？')){
			return false;
		}

	});
	
	
	//滚动到底部，当前tab（有.on的tab）加载下一页
	$(window).scroll(function(event){
		var scrollt = document.documentElement.scrollTop + document.body.scrollTop; //获取滚动后的高度
		var docHeight = $(document).height() - $(window).height()-1; //当前文档高度
		if(scrollt > docHeight){
		 	ajax("next",'.order-tab-title.on');
		}
	});
	
	//初始化，所有tab加载第一页
	$(function(){ 
		ajax("next",'#orderTab01');
		ajax("next",'#orderTab02');
	});
	
</script>
<script type="text/javascript">
	//标签切换，加载时显示默认标签
	function tabSwap(tabObj, conObj){
		var hashNum;
		
		$(tabObj).click(function(){
			var $this = $(this);
			var thisIndex = $this.index();
			var	state = {
					'url':'#orderNum=' + thisIndex
				};
			
			//点击切换标签
			$this.addClass('on').siblings().removeClass('on');
			$(conObj).eq(thisIndex).show()
					.siblings().hide();
				
			//记录上一次选中的tab
			history.replaceState(state, '', state.url); 
		});
		
		//加载时显示默认标签。如果存在浏览记录，则按照浏览记录显示标签
		if(location.hash){
			hashNum = location.hash.substring(10);
		}else{
		//否则显示第一个标签	
			hashNum = 0;
		}
				
		//页面加载时触发默认显示标签
		$(tabObj).eq(hashNum).click();
	}
	
	$(function(){
		tabSwap('.order-tab li', '#tabBox-bd .con');
	});
</script>

</body>
</html>